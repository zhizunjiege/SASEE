<!DOCTYPE html>
<html lang="zh_ch">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0,shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="icon" href="/pictures/favicon.ico">
    <link rel="stylesheet" href="/frames/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/system.css">
    <title>找回密码</title>
</head>

<body>
    <div class="container" id="container">
        <div class="row align-items-center justify-content-center" id="row">
            <div class="col-12 col-sm-10 col-md-8 col-lg-6 col-xl-4">
                <form action="" id="retrievePW_form" method="POST">
                    <div class="form-group form-row justify-content-around">
                        <p class="col-4 mb-0">身份：</p>
                        <div class="custom-control custom-radio custom-control-inline col-4 mr-0">
                            <input type="radio" name="identity" value="student" id="identity-s"
                                class="custom-control-input" checked>
                            <label for="identity-s" class="custom-control-label">Student</label>
                        </div>
                        <div class="custom-control custom-radio custom-control-inline col-4 mr-0">
                            <input type="radio" name="identity" value="teacher" id="identity-t"
                                class="custom-control-input">
                            <label for="identity-t" class="custom-control-label">Teacher</label>
                        </div>
                    </div>
                    <div class="form-group form-row">
                        <label class="col-3 col-form-label" for="account">账号：</label>
                        <input class="form-control col-9" type="number" name="account" id="account"
                            placeholder="请输入你的账号" min="16000000" max="99999999" required>
                    </div>
                    <div class="form-group form-row">
                        <label class="col-3 col-form-label" for="pin_code">验证码：</label>
                        <div class="input-group col-9 px-0">
                            <input class="form-control px-1" type="text" name="pinCode" id="pin_code"
                                placeholder="请输入验证码" pattern="\d{6}" required>
                            <div class="input-group-append">
                                <button id="pin_code_send" type="button" class="btn btn-outline-primary">发送验证码</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-group form-row">
                        <label for="pw_new" class="col-3 col-form-label">新密码：</label>
                        <input name="newPW" id="pw_new" type="password" class="col-9 form-control" placeholder="请输入新密码"
                            pattern="\w{8,16}" required>
                    </div>
                    <div class="form-group form-row">
                        <label for="pw_repeat" class="col-3 col-form-label">重复密码：</label>
                        <input name="repeatPW" id="pw_repeat" type="password" class="col-9 form-control"
                            placeholder="请重新输入新密码" pattern="\w{8,16}" required>
                    </div>
                    <div class="form-row justify-content-between align-items-center mb-3">
                        <button class="btn btn-secondary w-25" type="reset">重置</button>
                        <button class="btn btn-primary w-25" type="submit">提交</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="modal p-3" id="alert_modal">
        <div class="alert alert-primary">
            <h4 class="alert-heading">找回密码成功，请使用新密码登陆！</h4>
            <p>将在<strong id="jump_counter" class="px-1">5</strong>秒后自动跳转至登陆界面,点击<a href="/"
                    class="alert-link">此处</a>立即跳转。</p>
        </div>
    </div>
    <%- include('./alert') %>
    <script src="/frames/others/jquery-3.4.0.js"></script>
    <script src="/frames/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script>
        (function ($) {
            let $form = $(document.forms[0]);
            function _countDown(count, doing, done) {
                if (count) {
                    doing(count--);
                    setTimeout(() => {
                        _countDown(count, doing, done);
                    }, 1000);
                } else {
                    done();
                }
            }
            function _alert(msg = '网络错误，请稍后重试！') {
                $('.alert>span').text(msg);
                $('.alert-modal').modal({
                    backdrop: 'static',
                    keyboard: false
                });
            }
            $form.submit(e => {
                e.preventDefault();
                if ($form[0].newPW.value == $form[0].repeatPW.value) {
                    $.post('/password/retrieve', $form.serialize()).done(data => {
                        $('#retrievePW_modal').modal('hide');
                        $('#alert_modal').modal({
                            backdrop: 'static',
                            keyboard: false
                        });
                        _countDown(3, count => {
                            $('#jump_counter').text(count);
                        }, () => {
                            window.location.href = '/';
                        });
                    }).fail(xhr => {
                        _alert(xhr.responseText);
                    });
                } else {
                    _alert('密码不匹配，请重新输入！');
                }
            });
            let $pin_code_send = $('#pin_code_send');
            $pin_code_send.click(e => {
                let identity = $form[0].identity.value,
                    account = $form[0].account.value;
                if (identity && account) {
                    $.get('/password/sendPinCode', { identity, account }).done(msg => {
                        _alert(msg);
                        $pin_code_send[0].setAttribute('disabled', true);
                        _countDown(60, count => {
                            $pin_code_send.text(count + 's');
                        }, () => {
                            $pin_code_send.text('发送验证码');
                            $pin_code_send[0].removeAttribute('disabled')
                        });
                    }).fail(xhr => {
                        _alert(xhr.responseText);
                    });
                } else {
                    _alert('请输入身份和账号等信息！');
                }
            });
        })(window.jQuery);
    </script>
</body>

</html>